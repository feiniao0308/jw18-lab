---
- name: Deploy Infra Components for Cloud-Native Labs at Red Hat Summit 2018
  hosts: localhost
  gather_facts: false
  run_once: true
  vars:
    lab_infra_project: lab-infra
    user_gogs_admin: gogs
    user_gogs_user: developer
    user_gogs_password: openshift
    openshift_cli: oc
    github_account: openshift-labs
    github_ref: master
    project_suffix: 

  tasks:
    - include_role:
        name: openshift_common_facts
      tags: always

    - name: create lab infra project
      shell: "{{ openshift_cli }} new-project {{ lab_infra_project }} --display-name='Lab Infra'"
      ignore_errors: true
      tags: always

    # deploy nexus
    - import_role:
        name: openshift_sonatype_nexus
      vars:
        project_name: "{{ lab_infra_project }}"
        nexus_image_version: 3.7.1
        nexus_max_memory: 6Gi
      tags: nexus

    # deploy gogs
    - set_fact:
        gogs_hostname: gogs-{{ lab_infra_project }}.{{ apps_hostname_suffix }}
      tags: always

    - import_role:
        name: openshift_gogs
      vars:
        project_name: "{{ lab_infra_project }}"
        gogs_route: "{{ gogs_hostname }}"
        gogs_image_version: 0.11.34
        gogs_admin_user: "{{ user_gogs_admin }}"
        gogs_admin_password: "{{ user_gogs_password }}"
        gogs_user: "{{ user_gogs_user }}"
        gogs_password: "{{ user_gogs_password }}"
        clean_deploy: true
      tags: gogs

    - name: wait for gogs to be running
      uri:
        url: http://{{ gogs_hostname }}
        status_code: 200
      register: result
      until: result.status == 200
      retries: "30"
      delay: "10"
      tags: gogs

    - name: check if catalog git repository exists
      uri:
        url: http://{{ gogs_hostname }}/api/v1/repos/{{ user_gogs_user }}/catalog
        user: "{{ user_gogs_user }}"
        password: "{{ user_gogs_password }}"
        force_basic_auth: true
        status_code: 200,404
      register: repo_result
      tags: gogs

    - name: create catalog git repository
      uri:
        url: http://{{ gogs_hostname }}/api/v1/user/repos
        method: POST
        body: '{"name": "catalog", "private": false}'
        body_format: json
        user: "{{ user_gogs_user }}"
        password: "{{ user_gogs_password }}"
        status_code: 200,201
        force_basic_auth: true
      when: repo_result.status != 200
      tags: gogs

    - name: create temporary git directory
      tempfile:
        state: directory
        prefix: projects-git
      register: git_dir
      when: repo_result.status != 200
      tags: gogs

    - name: unarchive projects source archive
      unarchive:
        remote_src: yes
        src: "https://github.com/{{ github_account }}/rhsummit18-cloudnative-labs/archive/{{ github_ref }}.zip"
        dest: "{{ git_dir.path }}"
      when: repo_result.status != 200
      tags: gogs

    - name: push catalog to git repository in Gogs
      shell: |
        git init
        git remote add origin http://{{ user_gogs_user }}:{{ user_gogs_password }}@{{ gogs_hostname }}/{{ user_gogs_user }}/catalog.git
        git add . --all
        git config user.email "rhdeveloper@redhat.com"
        git config user.name "rh-developer"
        git commit -m "Initial add"
        git push origin master
      args:
        chdir: "{{ git_dir.path }}/rhsummit18-cloudnative-labs-{{ github_ref }}/catalog"
      when: repo_result.status != 200
      tags: gogs

    # deploy guides
    - import_role:
        name: openshift_workshopper
      vars:
        project_name: "{{ lab_infra_project }}"
        workshopper_content_url_prefix: "https://raw.githubusercontent.com/openshift-labs/rhsummit18-cloudnative-guides/master"
        workshopper_workshop_urls: "https://raw.githubusercontent.com/openshift-labs/rhsummit18-cloudnative-guides/master/_rhsummit18.yml"
        workshopper_env_vars:
          PROJECT_SUFFIX: ""
          GOGS_URL: http://{{ gogs_hostname }}
          OPENSHIFT_DOCS_BASE: "https://docs.openshift.com/container-platform/3.9"
      tags: guides

    # deploy eclipse che
    - import_role:
        name: openshift_eclipse_che
      vars:
        project_name: "{{ lab_infra_project }}"
        #che_version: "6.3.0"
        che_version: "nightly"
        route_suffix: "{{ apps_hostname_suffix }}"
      tags: eclipse-che

    - name: wait for eclipse che to be running
      uri:
        url: http://che-{{ lab_infra_project }}.{{ apps_hostname_suffix }}/api/
        status_code: 200
      register: result
      until: result.status == 200
      retries: "30"
      delay: "10"
      tags: eclipse-che

    - name: create custom stack for jdk and openshift cli
      uri:
        url: http://che-{{ lab_infra_project }}.{{ apps_hostname_suffix }}/api/stack
        method: POST
        body: |
          {
            "name": "Java RH Summit",
            "description": "Java JDK Stack on CentOS for Red Hat Summit 2018 Labs",
            "scope": "general",
            "workspaceConfig": {
              "environments": {
                "default": {
                  "recipe": {
                    "type": "dockerimage",
                    "content": "siamaksade/che-centos-jdk8:spring-boot-dep"
                  },
                  "machines": {
                    "dev-machine": {
                      "env": {},
                      "servers": {
                        "8080/tcp": {
                          "attributes": {},
                          "protocol": "http",
                          "port": "8080"
                        },
                        "8000/tcp": {
                          "attributes": {},
                          "protocol": "http",
                          "port": "8000"
                        }
                      },
                      "volumes": {},
                      "installers": [
                        "org.eclipse.che.exec",
                        "org.eclipse.che.terminal",
                        "org.eclipse.che.ws-agent"
                      ],
                      "attributes": {
                        "memoryLimitBytes": "2147483648"
                      }
                    }
                  }
                }
              },
              "commands": [
                {
                  "commandLine": "mvn install -f ${current.project.path} -s ${current.project.path}/.settings.xml",
                  "name": "build",
                  "type": "mvn",
                  "attributes": {
                    "goal": "Build",
                    "previewUrl": ""
                  }
                },
                {
                  "commandLine": "mvn clean install -f ${current.project.path} -s ${current.project.path}/.settings.xml",
                  "name": "clean build",
                  "type": "mvn",
                  "attributes": {
                    "goal": "Build",
                    "previewUrl": ""
                  }
                },
                {
                  "commandLine": "mvn spring-boot:run -f ${current.project.path} -s ${current.project.path}/.settings.xml",
                  "name": "run",
                  "type": "custom",
                  "attributes": {
                    "goal": "Run",
                    "previewUrl": "${server.8080/tcp}"
                  }
                },
                {
                  "commandLine": "mvn spring-boot:run -f ${current.project.path} -s ${current.project.path}/.settings.xml -Drun.jvmArguments=\"-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005\"",
                  "name": "debug",
                  "type": "custom",
                  "attributes": {
                    "goal": "Debug",
                    "previewUrl": "${server.8080/tcp}"
                  }
                }
              ],
              "projects": [],
              "defaultEnv": "default",
              "name": "default",
              "links": []
            },
            "components": [
              {
                "version": "---",
                "name": "CentOS"
              },
              {
                "version": "1.8.0_45",
                "name": "JDK"
              },
              {
                "version": "3.2.2",
                "name": "Maven"
              },
              {
                "version": "2.4",
                "name": "Ansible"
              },
              {
                "version": "3.9.14",
                "name": "OpenShift CLI"
              }
            ],
            "creator": "ide",
            "tags": [
              "Java",
              "JDK",
              "Maven",
              "Ansible",
              "CentOS",
              "Git"
            ],
            "id": "java-centos-rhsummit18"
          }
        body_format: json
        status_code: 200,201
      tags: eclipse-che

    # create prod
    - name: create prod project
      shell: "{{ openshift_cli }} new-project prod{{ project_suffix }} --display-name='CoolStore PROD'"
      ignore_errors: true

    - name: deploy web in prod
      shell: "{{ openshift_cli }} new-app -f https://raw.githubusercontent.com/{{ github_account }}/rhsummit18-cloudnative-labs/{{ github_ref }}/openshift/web-template.yml --param=IMAGE_VERSION=prod -n prod{{ project_suffix }}"
      ignore_errors: true

    - name: deploy inventory in prod
      shell: "{{ openshift_cli }} new-app -f https://raw.githubusercontent.com/{{ github_account }}/rhsummit18-cloudnative-labs/{{ github_ref }}/openshift/inventory-template.yml --param=IMAGE_VERSION=prod -n prod{{ project_suffix }}"
      ignore_errors: true

    - name: deploy catalog in prod
      shell: "{{ openshift_cli }} new-app -f https://raw.githubusercontent.com/{{ github_account }}/rhsummit18-cloudnative-labs/{{ github_ref }}/openshift/catalog-template.yml --param=IMAGE_VERSION=prod -n prod{{ project_suffix }}"
      ignore_errors: true

    # validate cluster
    - name: check openjdk image stream installed
      shell: "{{ openshift_cli }} get is redhat-openjdk18-openshift -n openshift"
      register: jdk_imagestream_result
      ignore_errors: true
      tags: validate

    - name: display instructions to install openjdk image stream
      debug:
        msg:
          - '### WARNING ###'
          - 'OpenJDK image stream is not installed. Run the following as cluster admin:'
          - '{{ openshift_cli }} create -n openshift -f https://raw.githubusercontent.com/openshift/openshift-ansible/release-3.9/roles/openshift_examples/files/examples/v3.9/xpaas-streams/jboss-image-streams.json'
      when: jdk_imagestream_result|failed   
      tags: validate     

    # populate nexus
    - name: populate nexus
      shell: "{{ openshift_cli }} new-build redhat-openjdk18-openshift:1.2~http://{{ gogs_hostname }}/{{ user_gogs_user }}/catalog.git -e MAVEN_MIRROR_URL=http://nexus.{{ lab_infra_project }}.svc:8081/repository/maven-all-public/ -n {{ lab_infra_project }}"
      ignore_errors: true
      tags: populate-nexus

